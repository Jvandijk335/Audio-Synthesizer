#include "audio_effects.h"
#include <stdlib.h>
#include <string.h>

////------------------------------------------------------DELAY-------------------------------------------------------//

static q31_t *effect_buffer = NULL;
static uint32_t buffer_size = EFFECT_BUFFER_SIZE;
static uint32_t sample_rate = 0;
static uint32_t write_index = 0;
static EffectType active_effect = EFFECT_NONE;

// Delay
static uint32_t delay_offset = 0;

// Echo
static uint32_t echo_offset = 0;
static float echo_gain = 0.0f;

// Filter
static AudioFilter audio_filter = { .type = FILTER_NONE };

static const q31_t fir_lowpass_32taps[967] = {
		  -11099333,
		  -803794,
		  -832473,
		  -861531,
		  -890962,
		  -920740,
		  -950882,
		  -981370,
		  -1012178,
		  -1043233,
		  -1074535,
		  -1106104,
		  -1137912,
		  -1169893,
		  -1202010,
		  -1234312,
		  -1266767,
		  -1299270,
		  -1331868,
		  -1364626,
		  -1397324,
		  -1430158,
		  -1462940,
		  -1495787,
		  -1528635,
		  -1561503,
		  -1594350,
		  -1627228,
		  -1660063,
		  -1692864,
		  -1725605,
		  -1758284,
		  -1790895,
		  -1823388,
		  -1855740,
		  -1887931,
		  -1919892,
		  -1951571,
		  -1982934,
		  -2013931,
		  -2044559,
		  -2074719,
		  -2104431,
		  -2133650,
		  -2162395,
		  -2190582,
		  -2218391,
		  -2245637,
		  -2272625,
		  -2299192,
		  -2325400,
		  -2351363,
		  -2376996,
		  -2402175,
		  -2426838,
		  -2450825,
		  -2473857,
		  -2495630,
		  -2515930,
		  -2534694,
		  -2552029,
		  -2568462,
		  -2585082,
		  -2603639,
		  -2626008,
		  -2651418,
		  -2642569,
		  -2666908,
		  -2678544,
		  -2689967,
		  -2700490,
		  -2710064,
		  -2718630,
		  -2726152,
		  -2732583,
		  -2737959,
		  -2742274,
		  -2745473,
		  -2747521,
		  -2748432,
		  -2748239,
		  -2746878,
		  -2744319,
		  -2740652,
		  -2735846,
		  -2729772,
		  -2722611,
		  -2714171,
		  -2704604,
		  -2693805,
		  -2681809,
		  -2668577,
		  -2654138,
		  -2638395,
		  -2621384,
		  -2603072,
		  -2583471,
		  -2562581,
		  -2540384,
		  -2516913,
		  -2492180,
		  -2466171,
		  -2438915,
		  -2410448,
		  -2380789,
		  -2349963,
		  -2317928,
		  -2284737,
		  -2250327,
		  -2214687,
		  -2177733,
		  -2139572,
		  -2099986,
		  -2059286,
		  -2017183,
		  -1973939,
		  -1929677,
		  -1884355,
		  -1838072,
		  -1790950,
		  -1742912,
		  -1693787,
		  -1643422,
		  -1591731,
		  -1538699,
		  -1484457,
		  -1429445,
		  -1374253,
		  -1319232,
		  -1263671,
		  -1205238,
		  -1141681,
		  -1087264,
		  -1024986,
		  -964115,
		  -902355,
		  -839941,
		  -776875,
		  -713196,
		  -648948,
		  -584222,
		  -519019,
		  -453344,
		  -387244,
		  -320787,
		  -254007,
		  -186886,
		  -119496,
		  -51924,
		  15882,
		  83918,
		  152015,
		  220300,
		  288559,
		  356869,
		  425099,
		  493234,
		  561200,
		  629020,
		  696572,
		  763856,
		  830803,
		  897390,
		  963595,
		  1029364,
		  1094689,
		  1159563,
		  1223915,
		  1287690,
		  1350833,
		  1413277,
		  1474975,
		  1535813,
		  1595801,
		  1654879,
		  1713048,
		  1770214,
		  1826542,
		  1881735,
		  1936155,
		  1989360,
		  2041409,
		  2092307,
		  2141820,
		  2189853,
		  2236521,
		  2281907,
		  2326041,
		  2368931,
		  2410546,
		  2450702,
		  2489045,
		  2525366,
		  2559876,
		  2593301,
		  2626105,
		  2656992,
		  2682927,
		  2711424,
		  2735641,
		  2758727,
		  2779898,
		  2799244,
		  2816713,
		  2832274,
		  2845883,
		  2857584,
		  2867357,
		  2875153,
		  2880942,
		  2884725,
		  2886491,
		  2886165,
		  2883741,
		  2879291,
		  2872769,
		  2864111,
		  2853449,
		  2840619,
		  2825768,
		  2808787,
		  2789744,
		  2768621,
		  2745466,
		  2720189,
		  2692856,
		  2663411,
		  2631883,
		  2598272,
		  2562583,
		  2524877,
		  2485186,
		  2443504,
		  2399867,
		  2354300,
		  2306807,
		  2257390,
		  2206024,
		  2152780,
		  2097634,
		  2040636,
		  1981803,
		  1921320,
		  1859020,
		  1795340,
		  1729791,
		  1662771,
		  1594190,
		  1523860,
		  1451919,
		  1378564,
		  1303845,
		  1227819,
		  1150567,
		  1072111,
		  992335,
		  911115,
		  828602,
		  745196,
		  661247,
		  576463,
		  490016,
		  402160,
		  315747,
		  226405,
		  137470,
		  47647,
		  -42676,
		  -133522,
		  -224822,
		  -316502,
		  -408434,
		  -500583,
		  -592891,
		  -685273,
		  -777649,
		  -869974,
		  -962213,
		  -1054246,
		  -1145966,
		  -1237376,
		  -1328398,
		  -1418892,
		  -1508917,
		  -1598260,
		  -1686963,
		  -1774846,
		  -1861861,
		  -1947903,
		  -2032972,
		  -2116917,
		  -2199754,
		  -2281372,
		  -2361729,
		  -2440748,
		  -2518308,
		  -2594350,
		  -2668804,
		  -2741553,
		  -2812523,
		  -2881658,
		  -2948901,
		  -3014204,
		  -3077474,
		  -3138717,
		  -3197832,
		  -3254744,
		  -3309291,
		  -3361544,
		  -3411102,
		  -3458456,
		  -3502948,
		  -3544947,
		  -3584458,
		  -3621171,
		  -3654985,
		  -3685928,
		  -3713900,
		  -3738804,
		  -3760659,
		  -3779570,
		  -3795507,
		  -3808207,
		  -3817427,
		  -3823200,
		  -3825900,
		  -3825619,
		  -3821591,
		  -3813309,
		  -3803036,
		  -3787992,
		  -3769877,
		  -3748014,
		  -3722567,
		  -3693458,
		  -3660643,
		  -3624064,
		  -3583747,
		  -3539648,
		  -3491736,
		  -3440003,
		  -3384456,
		  -3325069,
		  -3261771,
		  -3194568,
		  -3123508,
		  -3048545,
		  -2969675,
		  -2886990,
		  -2800371,
		  -2709934,
		  -2615549,
		  -2517279,
		  -2415096,
		  -2309056,
		  -2199097,
		  -2085343,
		  -1967747,
		  -1846390,
		  -1721271,
		  -1592395,
		  -1459827,
		  -1323573,
		  -1183618,
		  -1040011,
		  -892797,
		  -742010,
		  -587698,
		  -429909,
		  -268752,
		  -104215,
		  63660,
		  234874,
		  409293,
		  587097,
		  767725,
		  951832,
		  1138571,
		  1328194,
		  1520865,
		  1716349,
		  1914518,
		  2115435,
		  2319031,
		  2525107,
		  2733495,
		  2944225,
		  3157407,
		  3372949,
		  3590551,
		  3809943,
		  4031283,
		  4254873,
		  4480258,
		  4706591,
		  4935604,
		  5165449,
		  5396981,
		  5629740,
		  5863756,
		  6098925,
		  6335154,
		  6572297,
		  6810291,
		  7049015,
		  7288348,
		  7528191,
		  7768482,
		  8009158,
		  8250073,
		  8491111,
		  8732203,
		  8973196,
		  9213934,
		  9454394,
		  9694372,
		  9933890,
		  10172752,
		  10410907,
		  10648221,
		  10884643,
		  11119964,
		  11354166,
		  11587062,
		  11818593,
		  12048639,
		  12277062,
		  12503808,
		  12728793,
		  12951882,
		  13172981,
		  13391992,
		  13608794,
		  13823256,
		  14035247,
		  14244738,
		  14451621,
		  14655829,
		  14857235,
		  15055879,
		  15251283,
		  15444044,
		  15633025,
		  15819000,
		  16001754,
		  16180904,
		  16356499,
		  16528620,
		  16697067,
		  16861623,
		  17022237,
		  17179006,
		  17331927,
		  17480777,
		  17625320,
		  17765526,
		  17901583,
		  18033427,
		  18160606,
		  18283136,
		  18401811,
		  18515161,
		  18624241,
		  18728445,
		  18827969,
		  18922705,
		  19012612,
		  19097609,
		  19177686,
		  19252745,
		  19322743,
		  19387674,
		  19447544,
		  19502334,
		  19551984,
		  19596494,
		  19635855,
		  19669983,
		  19698861,
		  19722527,
		  19740893,
		  19754060,
		  19761920,
		  19764551,
		  19761920,
		  19754060,
		  19740893,
		  19722527,
		  19698861,
		  19669983,
		  19635855,
		  19596494,
		  19551984,
		  19502334,
		  19447544,
		  19387674,
		  19322743,
		  19252745,
		  19177686,
		  19097609,
		  19012612,
		  18922705,
		  18827969,
		  18728445,
		  18624241,
		  18515161,
		  18401811,
		  18283136,
		  18160606,
		  18033427,
		  17901583,
		  17765526,
		  17625320,
		  17480777,
		  17331927,
		  17179006,
		  17022237,
		  16861623,
		  16697067,
		  16528620,
		  16356499,
		  16180904,
		  16001754,
		  15819000,
		  15633025,
		  15444044,
		  15251283,
		  15055879,
		  14857235,
		  14655829,
		  14451621,
		  14244738,
		  14035247,
		  13823256,
		  13608794,
		  13391992,
		  13172981,
		  12951882,
		  12728793,
		  12503808,
		  12277062,
		  12048639,
		  11818593,
		  11587062,
		  11354166,
		  11119964,
		  10884643,
		  10648221,
		  10410907,
		  10172752,
		  9933890,
		  9694372,
		  9454394,
		  9213934,
		  8973196,
		  8732203,
		  8491111,
		  8250073,
		  8009158,
		  7768482,
		  7528191,
		  7288348,
		  7049015,
		  6810291,
		  6572297,
		  6335154,
		  6098925,
		  5863756,
		  5629740,
		  5396981,
		  5165449,
		  4935604,
		  4706591,
		  4480258,
		  4254873,
		  4031283,
		  3809943,
		  3590551,
		  3372949,
		  3157407,
		  2944225,
		  2733495,
		  2525107,
		  2319031,
		  2115435,
		  1914518,
		  1716349,
		  1520865,
		  1328194,
		  1138571,
		  951832,
		  767725,
		  587097,
		  409293,
		  234874,
		  63660,
		  -104215,
		  -268752,
		  -429909,
		  -587698,
		  -742010,
		  -892797,
		  -1040011,
		  -1183618,
		  -1323573,
		  -1459827,
		  -1592395,
		  -1721271,
		  -1846390,
		  -1967747,
		  -2085343,
		  -2199097,
		  -2309056,
		  -2415096,
		  -2517279,
		  -2615549,
		  -2709934,
		  -2800371,
		  -2886990,
		  -2969675,
		  -3048545,
		  -3123508,
		  -3194568,
		  -3261771,
		  -3325069,
		  -3384456,
		  -3440003,
		  -3491736,
		  -3539648,
		  -3583747,
		  -3624064,
		  -3660643,
		  -3693458,
		  -3722567,
		  -3748014,
		  -3769877,
		  -3787992,
		  -3803036,
		  -3813309,
		  -3821591,
		  -3825619,
		  -3825900,
		  -3823200,
		  -3817427,
		  -3808207,
		  -3795507,
		  -3779570,
		  -3760659,
		  -3738804,
		  -3713900,
		  -3685928,
		  -3654985,
		  -3621171,
		  -3584458,
		  -3544947,
		  -3502948,
		  -3458456,
		  -3411102,
		  -3361544,
		  -3309291,
		  -3254744,
		  -3197832,
		  -3138717,
		  -3077474,
		  -3014204,
		  -2948901,
		  -2881658,
		  -2812523,
		  -2741553,
		  -2668804,
		  -2594350,
		  -2518308,
		  -2440748,
		  -2361729,
		  -2281372,
		  -2199754,
		  -2116917,
		  -2032972,
		  -1947903,
		  -1861861,
		  -1774846,
		  -1686963,
		  -1598260,
		  -1508917,
		  -1418892,
		  -1328398,
		  -1237376,
		  -1145966,
		  -1054246,
		  -962213,
		  -869974,
		  -777649,
		  -685273,
		  -592891,
		  -500583,
		  -408434,
		  -316502,
		  -224822,
		  -133522,
		  -42676,
		  47647,
		  137470,
		  226405,
		  315747,
		  402160,
		  490016,
		  576463,
		  661247,
		  745196,
		  828602,
		  911115,
		  992335,
		  1072111,
		  1150567,
		  1227819,
		  1303845,
		  1378564,
		  1451919,
		  1523860,
		  1594190,
		  1662771,
		  1729791,
		  1795340,
		  1859020,
		  1921320,
		  1981803,
		  2040636,
		  2097634,
		  2152780,
		  2206024,
		  2257390,
		  2306807,
		  2354300,
		  2399867,
		  2443504,
		  2485186,
		  2524877,
		  2562583,
		  2598272,
		  2631883,
		  2663411,
		  2692856,
		  2720189,
		  2745466,
		  2768621,
		  2789744,
		  2808787,
		  2825768,
		  2840619,
		  2853449,
		  2864111,
		  2872769,
		  2879291,
		  2883741,
		  2886165,
		  2886491,
		  2884725,
		  2880942,
		  2875153,
		  2867357,
		  2857584,
		  2845883,
		  2832274,
		  2816713,
		  2799244,
		  2779898,
		  2758727,
		  2735641,
		  2711424,
		  2682927,
		  2656992,
		  2626105,
		  2593301,
		  2559876,
		  2525366,
		  2489045,
		  2450702,
		  2410546,
		  2368931,
		  2326041,
		  2281907,
		  2236521,
		  2189853,
		  2141820,
		  2092307,
		  2041409,
		  1989360,
		  1936155,
		  1881735,
		  1826542,
		  1770214,
		  1713048,
		  1654879,
		  1595801,
		  1535813,
		  1474975,
		  1413277,
		  1350833,
		  1287690,
		  1223915,
		  1159563,
		  1094689,
		  1029364,
		  963595,
		  897390,
		  830803,
		  763856,
		  696572,
		  629020,
		  561200,
		  493234,
		  425099,
		  356869,
		  288559,
		  220300,
		  152015,
		  83918,
		  15882,
		  -51924,
		  -119496,
		  -186886,
		  -254007,
		  -320787,
		  -387244,
		  -453344,
		  -519019,
		  -584222,
		  -648948,
		  -713196,
		  -776875,
		  -839941,
		  -902355,
		  -964115,
		  -1024986,
		  -1087264,
		  -1141681,
		  -1205238,
		  -1263671,
		  -1319232,
		  -1374253,
		  -1429445,
		  -1484457,
		  -1538699,
		  -1591731,
		  -1643422,
		  -1693787,
		  -1742912,
		  -1790950,
		  -1838072,
		  -1884355,
		  -1929677,
		  -1973939,
		  -2017183,
		  -2059286,
		  -2099986,
		  -2139572,
		  -2177733,
		  -2214687,
		  -2250327,
		  -2284737,
		  -2317928,
		  -2349963,
		  -2380789,
		  -2410448,
		  -2438915,
		  -2466171,
		  -2492180,
		  -2516913,
		  -2540384,
		  -2562581,
		  -2583471,
		  -2603072,
		  -2621384,
		  -2638395,
		  -2654138,
		  -2668577,
		  -2681809,
		  -2693805,
		  -2704604,
		  -2714171,
		  -2722611,
		  -2729772,
		  -2735846,
		  -2740652,
		  -2744319,
		  -2746878,
		  -2748239,
		  -2748432,
		  -2747521,
		  -2745473,
		  -2742274,
		  -2737959,
		  -2732583,
		  -2726152,
		  -2718630,
		  -2710064,
		  -2700490,
		  -2689967,
		  -2678544,
		  -2666908,
		  -2642569,
		  -2651418,
		  -2626008,
		  -2603639,
		  -2585082,
		  -2568462,
		  -2552029,
		  -2534694,
		  -2515930,
		  -2495630,
		  -2473857,
		  -2450825,
		  -2426838,
		  -2402175,
		  -2376996,
		  -2351363,
		  -2325400,
		  -2299192,
		  -2272625,
		  -2245637,
		  -2218391,
		  -2190582,
		  -2162395,
		  -2133650,
		  -2104431,
		  -2074719,
		  -2044559,
		  -2013931,
		  -1982934,
		  -1951571,
		  -1919892,
		  -1887931,
		  -1855740,
		  -1823388,
		  -1790895,
		  -1758284,
		  -1725605,
		  -1692864,
		  -1660063,
		  -1627228,
		  -1594350,
		  -1561503,
		  -1528635,
		  -1495787,
		  -1462940,
		  -1430158,
		  -1397324,
		  -1364626,
		  -1331868,
		  -1299270,
		  -1266767,
		  -1234312,
		  -1202010,
		  -1169893,
		  -1137912,
		  -1106104,
		  -1074535,
		  -1043233,
		  -1012178,
		  -981370,
		  -950882,
		  -920740,
		  -890962,
		  -861531,
		  -832473,
		  -803794,
		  -11099333

};

static const q31_t fir_highpass_32taps[32] = {
   -14400000, -28800000, -43200000, -57600000, -72000000, -86400000, -100800000, -115200000,
   -129600000, -144000000, -158400000, -172800000, 252000000, -201600000, 216000000, -230400000,
    230400000, -216000000, 201600000, -187200000, 172800000, -158400000, 144000000, -129600000,
    115200000, -100800000, 86400000, -72000000, 57600000, -43200000, 28800000, -14400000
};



/*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 96000 Hz

fixed point precision: 32 bits

* 0 Hz - 200 Hz
  gain = 0
  desired attenuation = -30 dB
  actual attenuation = n/a

* 300 Hz - 20000 Hz
  gain = 1
  desired ripple = 8 dB
  actual ripple = n/a

* 21000 Hz - 48000 Hz
  gain = 0
  desired attenuation = -30 dB
  actual attenuation = n/a

*/

#define FILTER_TAP_NUM 581

static q31_t filter_taps[FILTER_TAP_NUM] = {
  -111609428, -177828373, -151924472, -22868689, 89234431, 77810391, -14595871, -50969901,
  15277321, 80022022, 43767828, -39190735, -40840530, 44772606, 86533575, 14872609,
  -64480074, -26194504, 77086494, 85338320, -22319692, -83759974, 2091267, 109552535,
  68808744, -67067037, -89480792, 45466973, 134604750, 32430580, -113082402, -74184780,
  100293260, 142565597, -24150262, -150088241, -32860366, 157808417, 124101067, -95782418,
  -165753679, 34603053, 204891774, 73091636, -171311778, -148497132, 121619484, 226208974,
  -10504875, -234507219, -90874962, 214379744, 207562636, -118577060, -266675000, 7066679,
  293109567, 139953528, -234393549, -250710856, 135482765, 335289264, 23457024, -334246159,
  -175893375, 274338373, 320517599, -130197401, -391384658, -42336047, 395535688, 236101952,
  -297364718, -381749385, 136165844, 467610720, 82132060, -445122890, -290449832, 331995768,
  462436690, -125375316, -536845557, -117531785, 506946812, 362675899, -354515421, -539977861,
  118585616, 618765073, 168271389, -561394405, -434529272, 381375176, 630085835, -99834825,
  -697732544, -220306886, 620846067, 518009422, -400231666, -721009784, 79088639, 782254765,
  282128354, -676460753, -605201357, 417057445, 817575822, -51175546, -866942489, -349671399,
  730315783, 697480517, -429876426, -917881904, 16291011, 950142425, 421055019, -783594039,
  -796496881, 435042025, 1016712543, 20564750, -1036199685, -501550874, 828839312, 893632823,
  -440554626, -1121624793, -68392586, 1113899351, 579340953, -876995471, -999795551, 433575109,
  1217798141, 112335526, -1197183049, -668858822, 911375962, 1096725272, -431933916, -1322263988,
  -170500475, 1265546534, 748533813, -952711645, -1204680015, 413692027, 1410772749, 218204014,
  -1342619060, -842082768, 975156065, 1295858115, -406497069, -1509984379, -282796741, 1398705134,
  918333392, -1009274613, -1400064981, 379272225, 1586414236, 329899199, -1467211354, -1010374279,
  1020132190, 1480181569, -369356086, -1676371467, -396111271, 1509396872, 1077707424, -1047966421,
  -1575553208, 336585986, 1737397373, 437683678, -1568319770, -1162778120, 1048924998, 1640086386,
  -327705478, -1815354665, -500401589, 1596433248, 1216129536, -1072672458, -1722599976, 293564961,
  1859080472, 531497409, -1646221006, -1289533410, 1066511989, 1768352914, -289949708, -1923886657,
  -585939554, 1661505410, 1324878079, -1089260154, -1835508052, 258731606, 1950064664, 602335007,
  -1703921501, -1383239813, 1079491616, 1861013422, -264390860, -2002101517, -644645662, 1708847468,
  1398279938, -1104611238, -1912035828, 240050721, 2012230538, 643512246, -1746453295, -1439801683,
  1094958802, 1917828377, -257935974, -2053203431, -671194116, 1744366795, 1434259638, -1125418433,
  -1953532008, 243455694, 2050071162, 651534797, -1779985139, -1458959410, 1119153060, 1941790236,
  -275301664, -2082523913, -663851273, 1774319218, 1434215575, -1157287674, -1964364419, 272223150,
  2069537270, 626131290, -1810779355, -1443687679, 1156805774, 1938193630, -318557253, -2096577523,
  -623669052, 1804681226, 1402221437, -1204237134, -1950459166, 327680665, 2077334327, 569172012,
  -1844497294, -1398154030, 1211980213, 1913084982, -389134113, -2101626144, -551214052, 1841813976,
  1340955199, -1271926003, -1915808602, 415591147, 2079488587, 474567393, -1890648158, -1316055816,
  1300820148, 1862016631, -515332958, -2102971166, -399969302, 1918985113, 1176580091, -1480030953,
  -1752372797, 1114678719, 3000166180, 1114678719, -1752372797, -1480030953, 1176580091, 1918985113,
  -399969302, -2102971166, -515332958, 1862016631, 1300820148, -1316055816, -1890648158, 474567393,
  2079488587, 415591147, -1915808602, -1271926003, 1340955199, 1841813976, -551214052, -2101626144,
  -389134113, 1913084982, 1211980213, -1398154030, -1844497294, 569172012, 2077334327, 327680665,
  -1950459166, -1204237134, 1402221437, 1804681226, -623669052, -2096577523, -318557253, 1938193630,
  1156805774, -1443687679, -1810779355, 626131290, 2069537270, 272223150, -1964364419, -1157287674,
  1434215575, 1774319218, -663851273, -2082523913, -275301664, 1941790236, 1119153060, -1458959410,
  -1779985139, 651534797, 2050071162, 243455694, -1953532008, -1125418433, 1434259638, 1744366795,
  -671194116, -2053203431, -257935974, 1917828377, 1094958802, -1439801683, -1746453295, 643512246,
  2012230538, 240050721, -1912035828, -1104611238, 1398279938, 1708847468, -644645662, -2002101517,
  -264390860, 1861013422, 1079491616, -1383239813, -1703921501, 602335007, 1950064664, 258731606,
  -1835508052, -1089260154, 1324878079, 1661505410, -585939554, -1923886657, -289949708, 1768352914,
  1066511989, -1289533410, -1646221006, 531497409, 1859080472, 293564961, -1722599976, -1072672458,
  1216129536, 1596433248, -500401589, -1815354665, -327705478, 1640086386, 1048924998, -1162778120,
  -1568319770, 437683678, 1737397373, 336585986, -1575553208, -1047966421, 1077707424, 1509396872,
  -396111271, -1676371467, -369356086, 1480181569, 1020132190, -1010374279, -1467211354, 329899199,
  1586414236, 379272225, -1400064981, -1009274613, 918333392, 1398705134, -282796741, -1509984379,
  -406497069, 1295858115, 975156065, -842082768, -1342619060, 218204014, 1410772749, 413692027,
  -1204680015, -952711645, 748533813, 1265546534, -170500475, -1322263988, -431933916, 1096725272,
  911375962, -668858822, -1197183049, 112335526, 1217798141, 433575109, -999795551, -876995471,
  579340953, 1113899351, -68392586, -1121624793, -440554626, 893632823, 828839312, -501550874,
  -1036199685, 20564750, 1016712543, 435042025, -796496881, -783594039, 421055019, 950142425,
  16291011, -917881904, -429876426, 697480517, 730315783, -349671399, -866942489, -51175546,
  817575822, 417057445, -605201357, -676460753, 282128354, 782254765, 79088639, -721009784,
  -400231666, 518009422, 620846067, -220306886, -697732544, -99834825, 630085835, 381375176,
  -434529272, -561394405, 168271389, 618765073, 118585616, -539977861, -354515421, 362675899,
  506946812, -117531785, -536845557, -125375316, 462436690, 331995768, -290449832, -445122890,
  82132060, 467610720, 136165844, -381749385, -297364718, 236101952, 395535688, -42336047,
  -391384658, -130197401, 320517599, 274338373, -175893375, -334246159, 23457024, 335289264,
  135482765, -250710856, -234393549, 139953528, 293109567, 7066679, -266675000, -118577060,
  207562636, 214379744, -90874962, -234507219, -10504875, 226208974, 121619484, -148497132,
  -171311778, 73091636, 204891774, 34603053, -165753679, -95782418, 124101067, 157808417,
  -32860366, -150088241, -24150262, 142565597, 100293260, -74184780, -113082402, 32430580,
  134604750, 45466973, -89480792, -67067037, 68808744, 109552535, 2091267, -83759974,
  -22319692, 85338320, 77086494, -26194504, -64480074, 14872609, 86533575, 44772606,
  -40840530, -39190735, 43767828, 80022022, 15277321, -50969901, -14595871, 77810391,
  89234431, -22868689, -151924472, -177828373, -111609428
};





int audio_effects_init(uint32_t sr) {
    if (effect_buffer != NULL) return 0;

    effect_buffer = calloc(buffer_size, sizeof(q31_t));
    if (!effect_buffer) {
        perror("effect buffer alloc");
        return -1;
    }

    sample_rate = sr;
    write_index = 0;
    active_effect = EFFECT_NONE;
    return 0;
}

void audio_effects_free(void) {
    free(effect_buffer);
    effect_buffer = NULL;
    active_effect = EFFECT_NONE;
    disable_filter();
}


// -------- Effect Activators -------- //
int enable_delay(float delay_ms) {
    if (!effect_buffer) return -1;

    uint32_t offset = (uint32_t)((delay_ms * sample_rate) / 1000.0f);
    if (offset >= buffer_size) offset = buffer_size - 1;

    delay_offset = offset;
    active_effect = EFFECT_DELAY;
    return 0;
}

int enable_echo(float delay_ms, float gain) {
    if (!effect_buffer) return -1;

    uint32_t offset = (uint32_t)((delay_ms * sample_rate) / 1000.0f);
    if (offset >= buffer_size) offset = buffer_size - 1;

    echo_offset = offset;
    echo_gain = gain;
    active_effect = EFFECT_ECHO;
    return 0;
}

EffectType get_active_effect(void) {
    return active_effect;
}

int disable_effect(){
	if(!effect_buffer) return -1;
	active_effect = EFFECT_NONE;
}

// -------- Filters -------- //
int enable_predefined_fir_filter(PredefinedFilterType filter_type) {
    const q31_t *coeffs = NULL;
    uint32_t num_taps;
    uint32_t block_size = 32;

    switch(filter_type) {
        case PREDEFINED_FILTER_LOWPASS:
            coeffs = fir_lowpass_32taps;
            num_taps = 967;
            break;
        case PREDEFINED_FILTER_HIGHPASS:
            coeffs = fir_highpass_32taps;
            num_taps = 32;
            break;
        case PREDEFINED_FILTER_CUSTOM:
        	coeffs = filter_taps;
        	num_taps = FILTER_TAP_NUM;
        default:
            return -1; // unknown filter
    }

    return enable_fir_filter(coeffs, num_taps, block_size);
}


int enable_fir_filter(const q31_t *coeffs, uint32_t num_taps, uint32_t block_size) {
    if (audio_filter.type != FILTER_NONE) {
        disable_filter();
    }

    audio_filter.fir.num_taps = num_taps;
    audio_filter.fir.block_size = block_size;
    audio_filter.fir.idx = 0;
    audio_filter.fir.initialized = 0;

    audio_filter.fir.input_buffer = (q31_t *)calloc(block_size, sizeof(q31_t));
    audio_filter.fir.output_buffer = (q31_t *)calloc(block_size, sizeof(q31_t));
    audio_filter.fir.state_buffer = (q31_t *)calloc(block_size + num_taps - 1, sizeof(q31_t));

    if (!audio_filter.fir.input_buffer || !audio_filter.fir.output_buffer || !audio_filter.fir.state_buffer) {
        disable_filter();
        return -1;
    }

    arm_fir_init_q31(&audio_filter.fir.fir, num_taps, coeffs, audio_filter.fir.state_buffer, block_size);
    audio_filter.fir.initialized = 1;
    audio_filter.type = FILTER_FIR;

    return 0;
}

void disable_filter(void) {
    if (audio_filter.type == FILTER_FIR) {
        free(audio_filter.fir.input_buffer);
        free(audio_filter.fir.output_buffer);
        free(audio_filter.fir.state_buffer);
        audio_filter.fir.initialized = 0;
    }
    audio_filter.type = FILTER_NONE;
}

// -------- Processor -------- //
q31_t process_effect(q31_t input_sample) {
    if (!effect_buffer) return input_sample;

    q31_t filtered_sample = input_sample;

    // -------- Filter Switch --------
    switch (audio_filter.type) {
        case FILTER_FIR: {
            FIRFilter *f = &audio_filter.fir;
            if (f->initialized) {
                memmove(&f->input_buffer[0], &f->input_buffer[1], (f->block_size - 1) * sizeof(q31_t));
                f->input_buffer[f->block_size - 1] = input_sample;

                f->idx++;
                if (f->idx >= f->block_size) {
                    arm_fir_fast_q31(&f->fir, f->input_buffer, f->output_buffer, f->block_size);
                    f->idx = f->block_size - 1;
                    filtered_sample = f->output_buffer[f->block_size - 1];
                }
            }
            break;
        }

        default:
            break;
    }

    // -------- Effect Switch --------
    if (active_effect == EFFECT_NONE) return filtered_sample;

    uint32_t read_index;
    q31_t delayed_sample;
    int64_t result;

    switch (active_effect) {
        case EFFECT_DELAY:
            read_index = (write_index + buffer_size - delay_offset) % buffer_size;
            delayed_sample = effect_buffer[read_index];
            effect_buffer[write_index] = filtered_sample;
            result = delayed_sample;
            break;

        case EFFECT_ECHO:
            read_index = (write_index + buffer_size - echo_offset) % buffer_size;
            delayed_sample = effect_buffer[read_index];
            int64_t scaled = ((int64_t)delayed_sample * (int64_t)(echo_gain * (1 << 31))) >> 31;
            result = (int64_t)filtered_sample + scaled;
            effect_buffer[write_index] = (q31_t)__SSAT(result, 31);
            break;

        default:
            result = filtered_sample;
            break;
    }

    write_index = (write_index + 1) % buffer_size;
    return (q31_t)__SSAT(result, 31);
}
