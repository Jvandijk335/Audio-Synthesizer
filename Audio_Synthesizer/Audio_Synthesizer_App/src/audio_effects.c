#include "audio_effects.h"
#include <stdlib.h>
#include <string.h>

////------------------------------------------------------DELAY-------------------------------------------------------//

static q31_t *effect_buffer = NULL;
static uint32_t buffer_size = EFFECT_BUFFER_SIZE;
static uint32_t sample_rate = 0;
static uint32_t write_index = 0;
static EffectType active_effect = EFFECT_NONE;

// Delay
static uint32_t delay_offset = 0;

// Echo
static uint32_t echo_offset = 0;
static float echo_gain = 0.0f;

// Filter
static AudioFilter audio_filter = { .type = FILTER_NONE };

static const q31_t fir_lowpass_32taps[32] = {
    14400000, 28800000, 43200000, 57600000, 72000000, 86400000, 100800000, 115200000,
    129600000, 144000000, 158400000, 172800000, 187200000, 201600000, 216000000, 230400000,
    230400000, 216000000, 201600000, 187200000, 172800000, 158400000, 144000000, 129600000,
    115200000, 100800000, 86400000, 72000000, 57600000, 43200000, 28800000, 14400000
};

static const q31_t fir_highpass_32taps[32] = {
   -14400000, -28800000, -43200000, -57600000, -72000000, -86400000, -100800000, -115200000,
   -129600000, -144000000, -158400000, -172800000, 252000000, -201600000, 216000000, -230400000,
    230400000, -216000000, 201600000, -187200000, 172800000, -158400000, 144000000, -129600000,
    115200000, -100800000, 86400000, -72000000, 57600000, -43200000, 28800000, -14400000
};

/*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 96000 Hz

fixed point precision: 32 bits

* 0 Hz - 200 Hz
  gain = 0
  desired attenuation = -30 dB
  actual attenuation = n/a

* 300 Hz - 20000 Hz
  gain = 1
  desired ripple = 8 dB
  actual ripple = n/a

* 21000 Hz - 48000 Hz
  gain = 0
  desired attenuation = -30 dB
  actual attenuation = n/a

*/

#define FILTER_TAP_NUM 581

static q31_t filter_taps[FILTER_TAP_NUM] = {
  -111609428, -177828373, -151924472, -22868689, 89234431, 77810391, -14595871, -50969901,
  15277321, 80022022, 43767828, -39190735, -40840530, 44772606, 86533575, 14872609,
  -64480074, -26194504, 77086494, 85338320, -22319692, -83759974, 2091267, 109552535,
  68808744, -67067037, -89480792, 45466973, 134604750, 32430580, -113082402, -74184780,
  100293260, 142565597, -24150262, -150088241, -32860366, 157808417, 124101067, -95782418,
  -165753679, 34603053, 204891774, 73091636, -171311778, -148497132, 121619484, 226208974,
  -10504875, -234507219, -90874962, 214379744, 207562636, -118577060, -266675000, 7066679,
  293109567, 139953528, -234393549, -250710856, 135482765, 335289264, 23457024, -334246159,
  -175893375, 274338373, 320517599, -130197401, -391384658, -42336047, 395535688, 236101952,
  -297364718, -381749385, 136165844, 467610720, 82132060, -445122890, -290449832, 331995768,
  462436690, -125375316, -536845557, -117531785, 506946812, 362675899, -354515421, -539977861,
  118585616, 618765073, 168271389, -561394405, -434529272, 381375176, 630085835, -99834825,
  -697732544, -220306886, 620846067, 518009422, -400231666, -721009784, 79088639, 782254765,
  282128354, -676460753, -605201357, 417057445, 817575822, -51175546, -866942489, -349671399,
  730315783, 697480517, -429876426, -917881904, 16291011, 950142425, 421055019, -783594039,
  -796496881, 435042025, 1016712543, 20564750, -1036199685, -501550874, 828839312, 893632823,
  -440554626, -1121624793, -68392586, 1113899351, 579340953, -876995471, -999795551, 433575109,
  1217798141, 112335526, -1197183049, -668858822, 911375962, 1096725272, -431933916, -1322263988,
  -170500475, 1265546534, 748533813, -952711645, -1204680015, 413692027, 1410772749, 218204014,
  -1342619060, -842082768, 975156065, 1295858115, -406497069, -1509984379, -282796741, 1398705134,
  918333392, -1009274613, -1400064981, 379272225, 1586414236, 329899199, -1467211354, -1010374279,
  1020132190, 1480181569, -369356086, -1676371467, -396111271, 1509396872, 1077707424, -1047966421,
  -1575553208, 336585986, 1737397373, 437683678, -1568319770, -1162778120, 1048924998, 1640086386,
  -327705478, -1815354665, -500401589, 1596433248, 1216129536, -1072672458, -1722599976, 293564961,
  1859080472, 531497409, -1646221006, -1289533410, 1066511989, 1768352914, -289949708, -1923886657,
  -585939554, 1661505410, 1324878079, -1089260154, -1835508052, 258731606, 1950064664, 602335007,
  -1703921501, -1383239813, 1079491616, 1861013422, -264390860, -2002101517, -644645662, 1708847468,
  1398279938, -1104611238, -1912035828, 240050721, 2012230538, 643512246, -1746453295, -1439801683,
  1094958802, 1917828377, -257935974, -2053203431, -671194116, 1744366795, 1434259638, -1125418433,
  -1953532008, 243455694, 2050071162, 651534797, -1779985139, -1458959410, 1119153060, 1941790236,
  -275301664, -2082523913, -663851273, 1774319218, 1434215575, -1157287674, -1964364419, 272223150,
  2069537270, 626131290, -1810779355, -1443687679, 1156805774, 1938193630, -318557253, -2096577523,
  -623669052, 1804681226, 1402221437, -1204237134, -1950459166, 327680665, 2077334327, 569172012,
  -1844497294, -1398154030, 1211980213, 1913084982, -389134113, -2101626144, -551214052, 1841813976,
  1340955199, -1271926003, -1915808602, 415591147, 2079488587, 474567393, -1890648158, -1316055816,
  1300820148, 1862016631, -515332958, -2102971166, -399969302, 1918985113, 1176580091, -1480030953,
  -1752372797, 1114678719, 3000166180, 1114678719, -1752372797, -1480030953, 1176580091, 1918985113,
  -399969302, -2102971166, -515332958, 1862016631, 1300820148, -1316055816, -1890648158, 474567393,
  2079488587, 415591147, -1915808602, -1271926003, 1340955199, 1841813976, -551214052, -2101626144,
  -389134113, 1913084982, 1211980213, -1398154030, -1844497294, 569172012, 2077334327, 327680665,
  -1950459166, -1204237134, 1402221437, 1804681226, -623669052, -2096577523, -318557253, 1938193630,
  1156805774, -1443687679, -1810779355, 626131290, 2069537270, 272223150, -1964364419, -1157287674,
  1434215575, 1774319218, -663851273, -2082523913, -275301664, 1941790236, 1119153060, -1458959410,
  -1779985139, 651534797, 2050071162, 243455694, -1953532008, -1125418433, 1434259638, 1744366795,
  -671194116, -2053203431, -257935974, 1917828377, 1094958802, -1439801683, -1746453295, 643512246,
  2012230538, 240050721, -1912035828, -1104611238, 1398279938, 1708847468, -644645662, -2002101517,
  -264390860, 1861013422, 1079491616, -1383239813, -1703921501, 602335007, 1950064664, 258731606,
  -1835508052, -1089260154, 1324878079, 1661505410, -585939554, -1923886657, -289949708, 1768352914,
  1066511989, -1289533410, -1646221006, 531497409, 1859080472, 293564961, -1722599976, -1072672458,
  1216129536, 1596433248, -500401589, -1815354665, -327705478, 1640086386, 1048924998, -1162778120,
  -1568319770, 437683678, 1737397373, 336585986, -1575553208, -1047966421, 1077707424, 1509396872,
  -396111271, -1676371467, -369356086, 1480181569, 1020132190, -1010374279, -1467211354, 329899199,
  1586414236, 379272225, -1400064981, -1009274613, 918333392, 1398705134, -282796741, -1509984379,
  -406497069, 1295858115, 975156065, -842082768, -1342619060, 218204014, 1410772749, 413692027,
  -1204680015, -952711645, 748533813, 1265546534, -170500475, -1322263988, -431933916, 1096725272,
  911375962, -668858822, -1197183049, 112335526, 1217798141, 433575109, -999795551, -876995471,
  579340953, 1113899351, -68392586, -1121624793, -440554626, 893632823, 828839312, -501550874,
  -1036199685, 20564750, 1016712543, 435042025, -796496881, -783594039, 421055019, 950142425,
  16291011, -917881904, -429876426, 697480517, 730315783, -349671399, -866942489, -51175546,
  817575822, 417057445, -605201357, -676460753, 282128354, 782254765, 79088639, -721009784,
  -400231666, 518009422, 620846067, -220306886, -697732544, -99834825, 630085835, 381375176,
  -434529272, -561394405, 168271389, 618765073, 118585616, -539977861, -354515421, 362675899,
  506946812, -117531785, -536845557, -125375316, 462436690, 331995768, -290449832, -445122890,
  82132060, 467610720, 136165844, -381749385, -297364718, 236101952, 395535688, -42336047,
  -391384658, -130197401, 320517599, 274338373, -175893375, -334246159, 23457024, 335289264,
  135482765, -250710856, -234393549, 139953528, 293109567, 7066679, -266675000, -118577060,
  207562636, 214379744, -90874962, -234507219, -10504875, 226208974, 121619484, -148497132,
  -171311778, 73091636, 204891774, 34603053, -165753679, -95782418, 124101067, 157808417,
  -32860366, -150088241, -24150262, 142565597, 100293260, -74184780, -113082402, 32430580,
  134604750, 45466973, -89480792, -67067037, 68808744, 109552535, 2091267, -83759974,
  -22319692, 85338320, 77086494, -26194504, -64480074, 14872609, 86533575, 44772606,
  -40840530, -39190735, 43767828, 80022022, 15277321, -50969901, -14595871, 77810391,
  89234431, -22868689, -151924472, -177828373, -111609428
};





int audio_effects_init(uint32_t sr) {
    if (effect_buffer != NULL) return 0;

    effect_buffer = calloc(buffer_size, sizeof(q31_t));
    if (!effect_buffer) {
        perror("effect buffer alloc");
        return -1;
    }

    sample_rate = sr;
    write_index = 0;
    active_effect = EFFECT_NONE;
    return 0;
}

void audio_effects_free(void) {
    free(effect_buffer);
    effect_buffer = NULL;
    active_effect = EFFECT_NONE;
    disable_filter();
}


// -------- Effect Activators -------- //
int enable_delay(float delay_ms) {
    if (!effect_buffer) return -1;

    uint32_t offset = (uint32_t)((delay_ms * sample_rate) / 1000.0f);
    if (offset >= buffer_size) offset = buffer_size - 1;

    delay_offset = offset;
    active_effect = EFFECT_DELAY;
    return 0;
}

int enable_echo(float delay_ms, float gain) {
    if (!effect_buffer) return -1;

    uint32_t offset = (uint32_t)((delay_ms * sample_rate) / 1000.0f);
    if (offset >= buffer_size) offset = buffer_size - 1;

    echo_offset = offset;
    echo_gain = gain;
    active_effect = EFFECT_ECHO;
    return 0;
}

EffectType get_active_effect(void) {
    return active_effect;
}

int disable_effect(){
	if(!effect_buffer) return -1;
	active_effect = EFFECT_NONE;
}

// -------- Filters -------- //
int enable_predefined_fir_filter(PredefinedFilterType filter_type) {
    const q31_t *coeffs = NULL;
    uint32_t num_taps;
    uint32_t block_size = 32;

    switch(filter_type) {
        case PREDEFINED_FILTER_LOWPASS:
            coeffs = fir_lowpass_32taps;
            num_taps = 32;
            break;
        case PREDEFINED_FILTER_HIGHPASS:
            coeffs = fir_highpass_32taps;
            num_taps = 32;
            break;
        case PREDEFINED_FILTER_CUSTOM:
        	coeffs = filter_taps;
        	num_taps = FILTER_TAP_NUM;
        default:
            return -1; // unknown filter
    }

    return enable_fir_filter(coeffs, num_taps, block_size);
}


int enable_fir_filter(const q31_t *coeffs, uint32_t num_taps, uint32_t block_size) {
    if (audio_filter.type != FILTER_NONE) {
        disable_filter();
    }

    audio_filter.fir.num_taps = num_taps;
    audio_filter.fir.block_size = block_size;
    audio_filter.fir.idx = 0;
    audio_filter.fir.initialized = 0;

    audio_filter.fir.input_buffer = (q31_t *)calloc(block_size, sizeof(q31_t));
    audio_filter.fir.output_buffer = (q31_t *)calloc(block_size, sizeof(q31_t));
    audio_filter.fir.state_buffer = (q31_t *)calloc(block_size + num_taps - 1, sizeof(q31_t));

    if (!audio_filter.fir.input_buffer || !audio_filter.fir.output_buffer || !audio_filter.fir.state_buffer) {
        disable_filter();
        return -1;
    }

    arm_fir_init_q31(&audio_filter.fir.fir, num_taps, coeffs, audio_filter.fir.state_buffer, block_size);
    audio_filter.fir.initialized = 1;
    audio_filter.type = FILTER_FIR;

    return 0;
}

void disable_filter(void) {
    if (audio_filter.type == FILTER_FIR) {
        free(audio_filter.fir.input_buffer);
        free(audio_filter.fir.output_buffer);
        free(audio_filter.fir.state_buffer);
        audio_filter.fir.initialized = 0;
    }
    audio_filter.type = FILTER_NONE;
}

// -------- Processor -------- //
q31_t process_effect(q31_t input_sample) {
    if (!effect_buffer) return input_sample;

    q31_t filtered_sample = input_sample;

    // -------- Filter Switch --------
    switch (audio_filter.type) {
        case FILTER_FIR: {
            FIRFilter *f = &audio_filter.fir;
            if (f->initialized) {
                memmove(&f->input_buffer[0], &f->input_buffer[1], (f->block_size - 1) * sizeof(q31_t));
                f->input_buffer[f->block_size - 1] = input_sample;

                f->idx++;
                if (f->idx >= f->block_size) {
                    arm_fir_fast_q31(&f->fir, f->input_buffer, f->output_buffer, f->block_size);
                    f->idx = f->block_size - 1;
                    filtered_sample = f->output_buffer[f->block_size - 1];
                }
            }
            break;
        }

        default:
            break;
    }

    // -------- Effect Switch --------
    if (active_effect == EFFECT_NONE) return filtered_sample;

    uint32_t read_index;
    q31_t delayed_sample;
    int64_t result;

    switch (active_effect) {
        case EFFECT_DELAY:
            read_index = (write_index + buffer_size - delay_offset) % buffer_size;
            delayed_sample = effect_buffer[read_index];
            effect_buffer[write_index] = filtered_sample;
            result = delayed_sample;
            break;

        case EFFECT_ECHO:
            read_index = (write_index + buffer_size - echo_offset) % buffer_size;
            delayed_sample = effect_buffer[read_index];
            int64_t scaled = ((int64_t)delayed_sample * (int64_t)(echo_gain * (1 << 31))) >> 31;
            result = (int64_t)filtered_sample + scaled;
            effect_buffer[write_index] = (q31_t)__SSAT(result, 31);
            break;

        default:
            result = filtered_sample;
            break;
    }

    write_index = (write_index + 1) % buffer_size;
    return (q31_t)__SSAT(result, 31);
}
